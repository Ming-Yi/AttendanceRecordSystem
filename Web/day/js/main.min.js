eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('5 R(a){3 b=a.n("-");3 c="";C(3 i=0;i<b.G;i++){c+=b[i]}h(c-16)}5 t(){$(\'#l-k .s-j\').15(5(){$(g).14(\'j\',{13:$.12($(g).11()),Z:r,});$(g).Y({X:W,K:r,U:0})})}5 T(){$("#l-k y").S("");A(7.6["m"]!=E&&7.6["m"]!=""){3 a=7.6["m"].n(",");C(3 i=0;i<a.G;i++){$("#l-k y").Q("<B M=\'s-j\'>"+a[i]+"</B>")}t()}}5 L(){A(7.6["p"]!=E&&7.6["p"]!=""){3 a=I(7.6["p"]).n(",");$("#V").o(a[0]);$("#N").o(a[1]);$("#O").o(a[2])}}5 P(a){3 b=4.8.z.9("w-v");3 c=4.8.u.9("e");3 d=4.q.10(a,b,{J:c,f:4.f.F,D:4.x.e});h d.H()}5 I(a){3 b=4.8.z.9("w-v");3 c=4.8.u.9("e");3 d=4.q.17(a,b,{J:c,f:4.f.F,D:4.x.e});h d.H(4.8.18)}',62,71,'|||var|CryptoJS|function|localStorage|window|enc|parse|||||Pkcs7|mode|this|return||event|events|external|work|split|val|User|AES|true|fc|InitDraggable|Latin1|LAB|20160202AWIN|pad|span|Hex|if|div|for|padding|undefined|CBC|length|toString|DecryptData|iv|revert|loadUser|class|pwd|no|EncryptData|append|datefomat|html|loadWork|revertDuration|user|999|zIndex|draggable|stick|encrypt|text|trim|title|data|each|19110000|decrypt|Utf8'.split('|'),0,{}));
$(document).ready(function() {
	var checkboxdata = [];

	//Load LocalStorage Data
	loadWork();
	loadUser();

	//submit click listener and ajax data
	$("#submit").click(function() {
		var user = $("#user").val();
		var pwd = $("#pwd").val();
		var no = $("#no").val();
		var date = $('#calendar').fullCalendar( 'clientEvents' );
		var strdata = "";
		var str = "";
		var box = $("#save").prop("checked");
		if(user=="" || pwd=="" || no==""){
			alert("請寫基本資料");
			return false;
		}
		if(date == ""){
			alert("尚未填入日期");
			return false;
		}
		
		//將資料整理成json
		for(var i=0;i<date.length;i++){
			str+="{\"date\":\""+datefomat(date[i].start.format())+"\",\"work\":\""+date[i].title+"\"},"		
		}
		str = str.substring(0,str.length-1);
		strdata = "{\"user\":\""+user+"\",\"pwd\":\""+pwd+"\",\"schno\":\""+no+"\",\"day\":["+str+"]}";

		$.post('php/update.php', {"data":strdata}, function(datas) {
			if(datas=="ERROR"){
				alert("基本資料有誤");
			}
			else{
				if(box == true){
					window.localStorage["User"]=EncryptData(user+","+pwd+","+no);
				}
				$('#calendar').fullCalendar('removeEvents');
				alert("新增成功");					
			}
		});
	});

	//addwork click lister
	$("#addwork").click(function() {
		if($("#workname").val()=="")
			return false;
		$("#external-events span").append("<div class='fc-event'>"+$("#workname").val()+"</div>");
		if(window.localStorage["work"] == undefined || window.localStorage["work"].length == 0 )
			window.localStorage["work"]	= $("#workname").val()
		else
			window.localStorage["work"]	+= ","+$("#workname").val()
		InitDraggable();	
		$("#workname").val("");
	});

	//delwork click lister
	$("#delwork").click(function() {		
		$('.modal-body').html("");
		if(window.localStorage["work"] != undefined && window.localStorage["work"] != ""){
			checkboxdata=[];
			var work = window.localStorage["work"].split(",");
			for(var i=0; i<work.length;i++){
				checkboxdata.push(work[i]);
				$('.modal-body').append("<input type='checkbox' name='CheckBoxCities' value='"+work[i]+"' />"+work[i]+"<br/>");
			}
			$('#myModal').modal("show");
		}else{
			alert("沒有資料可以刪除");
		}		
	});

	//delete work's localStorage data
	$("#btn-del").click(function() {
		$('input[type=checkbox][name=CheckBoxCities]').each(function() 
		{
		    if (this.checked) 
		    {
		        var index = checkboxdata.indexOf($(this).val());
		        if (index > -1) {
				    checkboxdata.splice(index, 1);
				}
		    }
		});
		window.localStorage["work"] = checkboxdata;
		loadWork();
		$('#myModal').modal('hide');
	});

	// initialize Draggable
	InitDraggable();
	
	// initialize the calendar
	$('#calendar').fullCalendar({
	    columnFormat: {
	        month: 'dddd',
	        week: 'dddd M-d',
	        day: 'dddd M-d'
	    },
	    titleFormat: {
	        month: 'YYYY年 MM月',
	    },
		monthNames: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"],
		dayNames: ["星期天", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
		header: {
			left: '',
			center: 'title',
			right: 'prev,next today'
		},
		editable: true,
		droppable: true, 
		businessHours:true,
		//hiddenDays:[0,6],
		eventRender: function(event, element) {
			element.bind('dblclick', function() {
				$('#calendar').fullCalendar( 'removeEvents' ,  event._id);
				});
	   	},
	   	eventOverlap: function(stillEvent, movingEvent) {
	        stillEvent.allDay && movingEvent.allDay;
	    }
	});
});